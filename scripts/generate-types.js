#!/usr/bin/env node

import fs from 'fs/promises';
import path from 'path';

/**
 * OpenAPIä»•æ§˜æ›¸ã‹ã‚‰TypeScriptå‹å®šç¾©ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 */

const BACKEND_URL = process.env.BACKEND_URL || 'http://localhost:8000';
const OUTPUT_DIR = path.join(process.cwd(), 'src', 'types');
const OUTPUT_FILE = path.join(OUTPUT_DIR, 'api.ts');

function generateTypesFromSpec(openApiSpec) {
  try {
    console.log('ğŸ”§ ã‚«ã‚¹ã‚¿ãƒ å‹ç”Ÿæˆã‚’é–‹å§‹...');

    // åŸºæœ¬çš„ãªTypeScriptå‹å®šç¾©ã‚’ç”Ÿæˆ
    let typesContent = `// Generated from OpenAPI specification
// Do not edit this file manually

// API Response wrapper type
export type ApiResponse<T> = {
  success: true;
  data: T;
} | {
  success: false;
  error: string;
};

// Error response type
export interface ErrorResponse {
  success: false;
  error: string;
}

`;

    // ãƒ‘ã‚¹ã‹ã‚‰å‹ã‚’æ¨å®š
    if (openApiSpec.paths) {
      const paths = openApiSpec.paths;

      // ã‚¹ã‚­ãƒ¼ãƒãƒ™ãƒ¼ã‚¹ã®å‹å®šç¾©ã‚’ç”Ÿæˆ
      if (paths['/api/studylog']) {
        typesContent += `// Study Log types
export interface StudyLog {
  id?: number;
  date: string;
  subject: string;
  topics: string[];
  studyTime: number;
  understanding: number;
  memo?: string;
  efficiency?: number;
}

export type CreateStudyLogRequest = Omit<StudyLog, 'id' | 'efficiency'>;

`;
      }

      if (paths['/api/study/plan']) {
        typesContent += `// Study Plan types
export interface StudyWeek {
  id: number;
  weekNumber: number;
  title: string;
  phase: string;
  goals: string[];
  progressPercentage: number;
  totalStudyTime: number;
  averageUnderstanding: number;
}

export interface StudyDay {
  id: number;
  day: string;
  subject: string;
  topics: string[];
  estimatedTime: number;
  actualTime: number;
  completed: boolean;
  understanding: number;
  memo?: string;
}

`;
      }
    }

    // è¿½åŠ ã®æ±ç”¨å‹
    typesContent += `// Quiz and Test types (inferred from API structure)
export interface QuizSession {
  id: number;
  userId?: number;
  sessionType: 'category' | 'random' | 'review' | 'weak_points';
  category?: string;
  totalQuestions: number;
  correctAnswers: number;
  totalTime: number;
  avgTimePerQ: number;
  score: number;
  startedAt: string;
  completedAt?: string;
  isCompleted: boolean;
}

export interface Question {
  id: string;
  year: number;
  season: string;
  section: string;
  number: number;
  category: string;
  subcategory?: string;
  difficulty: number;
  question: string;
  choices: string[];
  tags?: string[];
}

export interface MorningTest {
  id?: number;
  date: string;
  category: string;
  totalQuestions: number;
  correctAnswers: number;
  accuracy?: number;
  timeSpent: number;
  memo?: string;
}

export interface AfternoonTest {
  id?: number;
  date: string;
  category: string;
  score: number;
  timeSpent: number;
  memo?: string;
}

// Request types
export type StartQuizSessionRequest = {
  sessionType: 'category' | 'random' | 'review' | 'weak_points';
  questionCount: number;
  category?: string;
};

export type SubmitAnswerRequest = {
  sessionId: number;
  questionId: string;
  userAnswer: string;
  timeSpent?: number;
};

export type CreateMorningTestRequest = Omit<MorningTest, 'id' | 'accuracy'>;
export type CreateAfternoonTestRequest = Omit<AfternoonTest, 'id'>;
`;

    console.log('âœ… ã‚«ã‚¹ã‚¿ãƒ å‹ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ');
    return typesContent;
  } catch (error) {
    console.error('âŒ ã‚«ã‚¹ã‚¿ãƒ å‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error.message);
    throw error;
  }
}

async function generateTypes() {
  try {
    console.log('ğŸ”„ OpenAPIä»•æ§˜æ›¸ã‹ã‚‰TypeScriptå‹ã‚’ç”Ÿæˆä¸­...');
    console.log(`ğŸ“¡ Backend URL: ${BACKEND_URL}/doc`);

    // å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    await fs.mkdir(OUTPUT_DIR, { recursive: true });

    // OpenAPIä»•æ§˜æ›¸ã‚’å–å¾—ã—ã¦å‹å®šç¾©ã‚’ç”Ÿæˆ
    console.log('ğŸ“¡ OpenAPIä»•æ§˜æ›¸ã‚’å–å¾—ä¸­...');
    const response = await fetch(`${BACKEND_URL}/doc`);

    if (!response.ok) {
      throw new Error(`OpenAPIä»•æ§˜æ›¸ã®å–å¾—ã«å¤±æ•—: ${response.status} ${response.statusText}`);
    }

    const openApiSpec = await response.json();
    console.log('âœ… OpenAPIä»•æ§˜æ›¸ã‚’å–å¾—ã—ã¾ã—ãŸ');

    // OpenAPIä»•æ§˜æ›¸ã‹ã‚‰ç›´æ¥å‹å®šç¾©ã‚’ç”Ÿæˆ
    console.log('ğŸ”„ OpenAPIä»•æ§˜æ›¸ã‹ã‚‰å‹å®šç¾©ã‚’ç”Ÿæˆä¸­...');
    const generatedTypes = generateTypesFromSpec(openApiSpec);

    // å‹å®šç¾©ã¯ã‚«ã‚¹ã‚¿ãƒ ç”Ÿæˆé–¢æ•°å†…ã§å®Œçµã—ã¦ã„ã‚‹ã®ã§ãã®ã¾ã¾ä½¿ç”¨
    const typesWithAdditions = generatedTypes;

    // ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    await fs.writeFile(OUTPUT_FILE, typesWithAdditions, 'utf8');

    console.log('âœ… OpenAPIã‹ã‚‰TypeScriptå‹å®šç¾©ã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
    console.log(`ğŸ“ å‡ºåŠ›å…ˆ: ${OUTPUT_FILE}`);

    // ç”Ÿæˆã•ã‚ŒãŸå‹ã®æ•°ã‚’è¡¨ç¤º
    const typeCount = (typesWithAdditions.match(/export type/g) || []).length;
    const interfaceCount = (typesWithAdditions.match(/export interface/g) || []).length;
    console.log(`ğŸ“Š ç”Ÿæˆã•ã‚ŒãŸå‹: ${typeCount} types, ${interfaceCount} interfaces`);
  } catch (error) {
    console.error('âŒ OpenAPIå‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error.message);

    // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
    console.log('ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹å®šç¾©ã‚’ä½¿ç”¨ã—ã¾ã™');
    await generateFallbackTypes();
  }
}

async function generateFallbackTypes() {
  try {
    // åŸºæœ¬çš„ãªå‹å®šç¾©ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    const fallbackTypes = `// Fallback type definitions (OpenAPI generation failed)
// Do not edit this file manually

export interface StudyLog {
  id: number;
  date: string;
  subject: string;
  topics: string[];
  studyTime: number;
  understanding: number;
  memo?: string;
  efficiency?: number;
}

export interface StudyWeek {
  id: number;
  weekNumber: number;
  title: string;
  phase: string;
  goals: string[];
  days: StudyDay[];
  progressPercentage: number;
  totalStudyTime: number;
  averageUnderstanding: number;
}

export interface StudyDay {
  id: number;
  day: string;
  subject: string;
  topics: string[];
  estimatedTime: number;
  actualTime: number;
  completed: boolean;
  understanding: number;
  memo?: string;
}

export interface QuizSession {
  id: number;
  userId?: number;
  sessionType: 'category' | 'random' | 'review' | 'weak_points';
  category?: string;
  totalQuestions: number;
  correctAnswers: number;
  totalTime: number;
  avgTimePerQ: number;
  score: number;
  startedAt: string;
  completedAt?: string;
  isCompleted: boolean;
}

export interface Question {
  id: string;
  year: number;
  season: string;
  section: string;
  number: number;
  category: string;
  subcategory?: string;
  difficulty: number;
  question: string;
  choices: string[];
  tags?: string[];
}

export interface MorningTest {
  id?: number;
  date: string;
  category: string;
  totalQuestions: number;
  correctAnswers: number;
  accuracy?: number;
  timeSpent: number;
  memo?: string;
}

export interface AfternoonTest {
  id?: number;
  date: string;
  category: string;
  score: number;
  timeSpent: number;
  memo?: string;
}

// Additional utility types
export type ApiResponse<T> = {
  success: true;
  data: T;
} | {
  success: false;
  error: string;
};

// Request types
export type CreateStudyLogRequest = Omit<StudyLog, 'id' | 'efficiency'>;
export type StartQuizSessionRequest = {
  sessionType: 'category' | 'random' | 'review' | 'weak_points';
  questionCount: number;
  category?: string;
};
export type SubmitAnswerRequest = {
  sessionId: number;
  questionId: string;
  userAnswer: string;
  timeSpent?: number;
};
export type CreateMorningTestRequest = Omit<MorningTest, 'id' | 'accuracy'>;
export type CreateAfternoonTestRequest = Omit<AfternoonTest, 'id'>;
`;

    // ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    await fs.writeFile(OUTPUT_FILE, fallbackTypes, 'utf8');

    console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹å®šç¾©ã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
    console.log(`ğŸ“ å‡ºåŠ›å…ˆ: ${OUTPUT_FILE}`);

    // ç”Ÿæˆã•ã‚ŒãŸå‹ã®æ•°ã‚’è¡¨ç¤º
    const typeCount = (fallbackTypes.match(/export type/g) || []).length;
    const interfaceCount = (fallbackTypes.match(/export interface/g) || []).length;
    console.log(`ğŸ“Š ç”Ÿæˆã•ã‚ŒãŸå‹: ${typeCount} types, ${interfaceCount} interfaces`);
  } catch (error) {
    console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error.message);

    // æœ€çµ‚çš„ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ - æ—¢å­˜ã®api.tsã‚’ä¿æŒ
    console.log('ğŸ’¡ æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢å­˜ã®api.tsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒã—ã¾ã™');

    // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æœ€å°é™ã®åŸºæœ¬å‹ã‚’ä½œæˆ
    try {
      await fs.access(OUTPUT_FILE);
      console.log('âœ… æ—¢å­˜ã®api.tsãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™');
    } catch {
      console.log('ğŸ“ æœ€å°é™ã®å‹å®šç¾©ã‚’ä½œæˆã—ã¾ã™');
      const basicTypes = `// Minimal type definitions (emergency fallback)
export interface StudyLog {
  id: number;
  date: string;
  subject: string;
  topics: string[];
  studyTime: number;
  understanding: number;
}

export type ApiResponse<T> = {
  success: true;
  data: T;
} | {
  success: false;
  error: string;
};
`;
      await fs.writeFile(OUTPUT_FILE, basicTypes, 'utf8');
    }
  }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œæ™‚ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®èµ·å‹•ç¢ºèª
async function checkBackend() {
  try {
    const response = await fetch(`${BACKEND_URL}/`);
    if (response.ok) {
      console.log('âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã¾ã™');
      return true;
    }
  } catch (error) {
    console.log('âš ï¸  ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“');
    return false;
  }
  return false;
}

async function main() {
  console.log('ğŸš€ APIå‹ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹');

  const backendRunning = await checkBackend();
  if (!backendRunning) {
    console.log('ğŸ’¡ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒèµ·å‹•ã—ã¦ã„ãªã„ãŸã‚ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹å®šç¾©ã‚’ä½¿ç”¨ã—ã¾ã™');
    await generateFallbackTypes();
  } else {
    console.log('âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒèµ·å‹•ã—ã¦ã„ã¾ã™ - OpenAPIé€£æºã‚’è©¦è¡Œã—ã¾ã™');
    await generateTypes();
  }

  console.log('ğŸ‰ å‹ç”Ÿæˆå®Œäº†!');
}

main();
